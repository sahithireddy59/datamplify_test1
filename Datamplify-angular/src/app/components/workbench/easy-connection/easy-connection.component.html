<!-- <app-page-header title="New Connection" moduleId="etlList" title1="Home" activeitem="Easy Connect"></app-page-header>

<div *ngIf="!isFormEnabled && !showList" class="main-container container-fluid TopHeader">
  <div class="row p-4">
    <div class="col-sm-12 col-lg-12 col-xl-12 p-0">
      <div class="card-header mb-3 border-0 d-flex justify-content-between align-items-center">
        <h4 class="card-title mb-0">Connect to Datasource</h4>
        <button class="btn btn-primary rounded-2" type="button" (click)="viewConnections();">
          <i class="fa fa-eye me-2"></i> View Connections
        </button>
      </div>

      <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 ">
          <div class="card card-body border Connect-Database-card">
            <h6 class="mb-3">Relational Database</h6>
            <div class="image-card-container">
              <div class="database-logo">
                <div class="imgcard p-4" (click)="isFormEnabled = true; isEditPreview = false">
                  <img src="./assets/images/Db_server_images/Relational Database/postgresql.png" alt="Image" class="card-img" />
                </div>
                <div class="logo-txt mt-2 text-center fw-600">
                  <span>PostgreSQL</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <div class="row ">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 ">
          <div class="card card-body border Connect-Database-card">
            <h6 class="mb-3">File Source</h6>
            <div class="image-card-container">
              <div class="database-logo">
                <div class="imgcard p-4" (click)="openUploadModal(uploadFileModal)">
                  <img src="./assets/images/Db_server_images/File Source/csv.png" alt="Image" class="card-img" />
                </div>
                <div class="logo-txt mt-2 text-center fw-600">
                  <span>CSV File</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="isFormEnabled" class="main-container container-fluid px-4 TopHeader">
  <div class="row">
    <div class="col-md-12 col-xl-6 p-1 mb-0">
      <div class="card Relational-database-height">
        <div class="card-header">
          <h4 class="card-title">Connect To PostgreSQL</h4>
        </div>
        <div class="card-body">
          <form>
            <div class="form-group">
              <label [ngClass]="{'error-label': serverError}" for="recipient-name" class="col-form-label">Server<span
                  class="text-danger ms-1">*</span></label>
              <input [ngClass]="{'error-input': serverError}" type="text" class="form-control"
                [(ngModel)]="serverName" [ngModelOptions]="{standalone: true}" placeholder="Host Name/Host Url"
                (input)="serverConditionError()">
            </div>
            <div class="form-group">
              <label [ngClass]="{'error-label': portError}" for="message-text" class="col-form-label">Port<span
                  class="text-danger ms-1">*</span></label>
              <input [ngClass]="{'error-input': portError}" type="text" class="form-control"
                [(ngModel)]="portName" [ngModelOptions]="{standalone: true}" placeholder="e.g. 5432"
                (input)="portConditionError()">
            </div>
            <div class="form-group">
              <label [ngClass]="{'error-label': databaseError}" class="col-form-label">Database<span
                  class="text-danger ms-1">*</span></label>
              <input [ngClass]="{'error-input': databaseError}" type="text" class="form-control"
                [(ngModel)]="databaseName" [ngModelOptions]="{standalone: true}" placeholder="e.g. PostgreSQL"
                (input)="databaseConditionError()">
            </div>
            <div class="form-group">
              <label [ngClass]="{'error-label': userNameError}" class="col-form-label">User Name <span
                  class="text-danger ms-1">*</span></label>
              <input [ngClass]="{'error-input': userNameError}" type="text" class="form-control"
                [(ngModel)]="userName" [ngModelOptions]="{standalone: true}" autocomplete="new-myname"
                placeholder="e.g. InsignApps" (input)="userNameConditionError()">
            </div>
            <div class="mb-2">
              <label [ngClass]="{'error-label': displayNameError}" class="col-form-label">Display Name <span
                  class="text-danger ms-1">*</span></label>
              <input [ngClass]="{'error-input': displayNameError}" type="text" class="form-control"
                [(ngModel)]="displayName" [ngModelOptions]="{standalone: true}" autocomplete="new-myname"
                placeholder="e.g. InsignApps" (input)="displayNameConditionError()">
            </div>
            <div class="form-group">
              <label [ngClass]="{'error-label': passwordError}" class="col-form-label">Password <span
                  class="text-danger ms-1">*</span></label>
              <div class="d-flex">
                <input [ngClass]="{'error-input': passwordError}" type="password" class="form-control"
                  [(ngModel)]="password" [ngModelOptions]="{standalone: true}" autocomplete="new-mypswd"
                  [type]="showPassword ? 'text' : 'password'" placeholder="e.g. ******"
                  (input)="passwordConditionError()">
                <button class="btn btn-light" (click)="toggleVisibility()" type="button" id="button-addon21"><i
                    class="ri-eye-{{toggleClass}} align-middle"></i></button>
              </div>

            </div>
            @if(isEditPreview && (schemaList && schemaList.length === 0)){
              <div class="form-group">
                <label class="col-form-label">Select Schema 
                  <i ngbTooltip="If you want change the schema then click on fetch schema" class="icon icon-info ms-1 cursor-pointer"></i> 
                </label>
                <input type="text" class="form-control" disabled [(ngModel)]="selectedSchema" [ngModelOptions]="{standalone: true}">
              </div>
            }
            @if(schemaList && schemaList.length > 0) {
            <div class="form-group">
              <label class="col-form-label">Select Schema <i
                  ngbTooltip="By default public schema will be selected, if no schema is choosen."
                  class="icon icon-info ms-1 cursor-pointer"></i> </label>
              <select id="schemaupdateSelect" [(ngModel)]="selectedSchema" [ngModelOptions]="{standalone: true}"
                class="form-select">
                <option *ngFor="let schema of schemaList" [value]="schema">{{ schema }}</option>
              </select>
            </div>
            }
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" [disabled]="disableConnectBtn" (click)="getSchemaList()">Fetch Schema</button>
              <button type="button" class="btn btn-secondary" (click)="isFormEnabled = false; resetForm(); isEditPreview ? showList = true : showList = false;">Close</button>
              <button type="button" class="btn btn-primary" (click)="isEditPreview ? updateDatabaseConnection(editPreviewData.id) : DatabaseConnection();" 
              [disabled]="disableConnectBtn">{{isEditPreview ? 'Update' : 'Connect'}}</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-md-12 col-xl-6 p-1 mb-0">
      <div class="card user-card border Relational-database-height">
        <div class="user-image">
          <span class="avatar w-20 h-20 rounded-circle mb-2 user-image-outline">
            <img src="./assets/images/Tiled view sheet icons/postgresql.jpg" alt=""
              class="rounded-circle bg-white user-image-border-color">
          </span>
        </div>
        <div class="card-body server-content-card">
          <ul class="">
            <li> <span class="mt-1">PostgreSQL is an advanced, enterprise-class open-source relational database
                that supports both SQL (relational) and JSON (non-relational) querying. </span></li>
            <li>
              <h6 class=" mt-3"><strong>Features</strong></h6>
            </li>
            <li><span class="mb-0"><strong>Open Source:</strong> PostgreSQL is available under an open-source license,
                so you can use, modify, and implement it without cost.</span></li>
            <li><span class="mb-0"><strong>Reliability:</strong> PostgreSQL is ACID-compliant and highly fault-tolerant.
              </span></li>
            <li><span class="mb-0"><strong>Flexibility:</strong> PostgreSQL offers more flexibility than other databases
                in terms
                of data types,scalability, concurrency, and data integrity. </span></li>
            <li> <span class="mb-0"><strong>For detail documentation:</strong> https://www.postgresql.org/docs/ </span>
            </li>
          </ul>
          <ul class="mt-2">
            <li><span class="mb-0"><strong>Server:</strong> Place your host url or host name </span> </li>
            <li><span class="mb-0"><strong>port:</strong> Example port number for postgresql is 5432 </span> </li>
            <li><span class="mb-0"><strong>Database:</strong> Please give your database name in this field</span> </li>
            <li><span class="mb-0"><strong>Username:</strong> Enter your username in this field</span> </li>
            <li><span class="mb-0"><strong>Password:</strong> Please give your password in this field</span> </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showList" class="main-container container-fluid TopHeader">
  <div class="row" class="card card-padding-top">
    <div class="col-sm-12 col-lg-12 col-xl-12 p-0">
      <div class="header-title-search">
        <div class="connect-txt">
          <h4 class="card-title mt-2">Connection List</h4>
        </div>
        <div class="new-data-btn d-flex text-align-center">
          <button *ngIf="gridView" type="button" ngbTooltip="Grid View" class="btn btn-icon btn-outline-primary me-1"><i
              class="fa fa-th-large"></i></button>
          <button *ngIf="gridView" type="button" ngbTooltip="Table View" (click)="gridView=false"
            class="btn btn-icon btn-primary-light me-3"><i class="fa fa-th-list"></i></button>

          <button *ngIf="!gridView" type="button" ngbTooltip="Grid View" (click)="gridView=true"
            class="btn btn-icon btn-primary-light me-1"><i class="fa fa-th-large"></i></button>
          <button *ngIf="!gridView" type="button" ngbTooltip="Table View"
            class="btn btn-icon btn-outline-primary me-3"><i class="fa fa-th-list"></i></button>
          <div class="input-group">
            <input type="text" class="form-control border-end-0 " placeholder="Search Connection"
              [(ngModel)]="searchConnections" aria-describedby="button-addon2" (keyup.enter)="getConnectionList()">
            <button class="btn btn-primary border me-2 search-icon-border-radius" type="button" id="button-addon2" (click)="getConnectionList()">
              <i class="fe fe-search"></i></button>
            
              <button class="btn btn-primary new-sheet-btn-radius me-2" (click)="showList = false">
                <i class="fe fe-plus me-1"></i>New Connection
              </button>
          </div>
        </div>
      </div>
      <div *ngIf="connectionList?.length === 0">
        Connect to new Connection!
      </div>

      <div *ngIf="connectionList?.length ?? 0 > 0" class="card-body card-p">
        @if(!gridView){
        <div class="table-responsive border table-responsive-height">
          <table class="table border text-nowrap text-md-nowrap mb-0">
            <thead class="table-primary bg-primary table-primary-position">
              <tr>
                <th>Datasources</th>
                <th>Server</th>
                <th>Created on</th>
                <th>Last Modified</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let database of connectionList | paginate : { itemsPerPage: pageSize, currentPage: page, totalItems: totalItems }">
                <td>
                  <a ngbTooltip="{{database?.display_name}}" (click)="database.server_type !== 'CSV' ? editPreviewDatabaseConnection(database?.hierarchy_id) : getFileConnection(database?.hierarchy_id, uploadFileModal)"> {{database?.display_name | slice:0:15}}</a>
                </td>
                <td *ngIf="database.server_type === 'POSTGRESQL'">
                  <img alt="product" src="./assets/images/icons/postSQL-icon.jpg"
                    class="w-5 h-5 border me-2">{{database.server_type}}
                </td>
                <td *ngIf="database.server_type === 'CSV'">
                  <img alt="product" src="./assets/images/icons/csv-icon.jpg" class="w-5 h-5 border me-2">{{database.server_type}}
                </td>
                <td>{{database?.created_at | date: 'yyyy-MM-dd HH:mm:ss'}}</td>
                <td>{{database?.updated_at | date: 'yyyy-MM-dd HH:mm:ss'}}</td>
                <td>
                  <div class="hstack gap-2 fs-1">
                    <button aria-label="anchor"
                      class="btn btn-icon btn-sm btn-info-light btn-wave waves-effect waves-light" 
                      (click)="database.server_type !== 'CSV' ? editPreviewDatabaseConnection(database?.hierarchy_id) : getFileConnection(database?.hierarchy_id, uploadFileModal)">
                      <i class="ri-edit-line" ngbTooltip="Edit connection"></i></button>
                    <a aria-label="anchor" class="btn btn-icon btn-sm btn-danger-light btn-wave waves-effect waves-light"
                      (click)="database.server_type === 'CSV' ? deleteFileConnection(database) : deleteDatabaseConnection(database)">
                      <i class="ri-delete-bin-7-line" ngbTooltip="Delete database"></i>
                    </a>
                  </div>
                </td>
              </tr>

            </tbody>
          </table>
        </div>
        }
        @if(gridView){
        <div class="row">
          <div *ngFor="let database of connectionList | paginate : { itemsPerPage: pageSize, currentPage: page, totalItems: totalItems }" class="col-md-12 col-xl-3">
            <div class="card card-box-shadow">
              <div class="card-header tiled-header-bg bg-primary tiled-card-header-padding">
                <div class="d-sm-flex align-items-center">
                  <span *ngIf="database.server_type === 'POSTGRESQL'" class="avatar rounded-circle">
                    <img src="./assets/images/charts/post-tiled-icon.jpg" alt="" class="rounded-circle">
                  </span>
                  <span *ngIf="database.server_type === 'CSV'" class="avatar avatar rounded-circle">
                    <img src="./assets/images/icons/csv-icon.jpg" alt="" class="rounded-circle">
                  </span>
                  <div class="ms-2 mt-sm-0 mt-2">
                    <h6 class="mb-1" (click)="database.server_type !== 'CSV' ? editPreviewDatabaseConnection(database?.hierarchy_id) : getFileConnection(database?.hierarchy_id, uploadFileModal)">
                      <a ngbTooltip="{{database?.display_name}}" class="float-start">{{database?.display_name |
                        slice:0:15}}</a>
                    </h6>

                  </div>
                </div>

                <div class="col-auto p-0">
                  <div class="d-flex justify-content-end p-1" ngbDropdown>
                    <a data-bs-toggle="dropdown" role="button" ngbDropdownToggle aria-haspopup="true"
                      aria-expanded="false" class=""><i class="fe fe-more-vertical fs-18 text-body-secondary"></i>
                    </a>
                    <div class="dropdown-menu" ngbDropdownMenu>
                      <a class="dropdown-item" (click)="database.server_type !== 'CSV' ? editPreviewDatabaseConnection(database?.hierarchy_id) : getFileConnection(database?.hierarchy_id, uploadFileModal)">
                        <i class="fe fe-edit me-2 d-inline-flex'"></i> Edit
                      </a>
                      <a class="dropdown-item btn btn-secondary-light" (click)="database.server_type === 'CSV' ? deleteFileConnection(database) : deleteDatabaseConnection(database);">
                        <i class="fe fe-trash me-2 d-inline-flex'"></i> Delete
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body title-card-body tiled-card-body-padding">
                <div class="row">

                  <div class="col-md-12">
                    <div class="row">
                      <div class="col-md-5">
                        <span class="fw-semibold fs-14">Created on:</span>
                      </div>
                      <div class="col-md-7">
                        <span class="fs-14">{{database?.created_at | date: 'yyyy-MM-dd HH:mm:ss'}}</span>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-5">
                        <span class="fw-semibold fs-14">Last Modified:</span>
                      </div>
                      <div class="col-md-7">
                        <span class="fs-14">{{database?.updated_at | date: 'yyyy-MM-dd HH:mm:ss'}}</span>
                      </div>
                    </div>

                  </div>

                </div>
              </div>
            </div>


          </div>
        </div>
        }
        <pagination-controls previousLabel="Prev" nextLabel="Next"
          (pageChange)="page = $event; getConnectionList();"></pagination-controls>
        <div class="pagination-count">
          <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()" class="form-control cursor">
            <option value="10"> 10</option>
            <option [disabled]="!(totalItems > 10)" value="20"> 20</option>
            <option [disabled]="!(totalItems > 20)" value="30"> 30</option>
          </select>
        </div>
      </div>
    </div>
  </div>

</div>

<ng-template #uploadFileModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">{{isEditPreview ? 'Replace' : 'Upload'}} File</h5>
    <button type="button" class="btn-close btn-light" aria-label="Close" (click)="this.selectedFile = null; this.displayName = ''; modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3">
      <label class="form-label fw-bold">Choose File</label>
      <div class="input-group">
        <label class="input-group-text btn btn-primary">
          <i class="bi bi-upload"></i> Choose File
          <input type="file" accept=".csv" (change)="onCsvFileSelected($event)" hidden #modalFileInput />
        </label>
        <input type="text" class="form-control" [value]="selectedFile?.name" readonly />
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">Display Name</label>
      <input type="text" class="form-control" placeholder="Enter display name" [(ngModel)]="displayName" />
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-outline-secondary" (click)="selectedFile = null; displayName = ''; modal.dismiss()">Cancel</button>
    <button class="btn btn-primary" [disabled]="!selectedFile || !displayName" (click)="fileConnection(modal, isEditPreview ? editPreviewData?.id : '')">Upload</button>
  </div>
</ng-template> -->


<div class="connections-page">
  <div class="page-header glass">
    <div class="title">
      <h1>Connection List</h1>
      <p class="subtitle">Manage your data connections</p>
    </div>

    <div class="header-actions">
      <div class="search-wrap">
        <svg class="icon search-icon" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input type="text" placeholder="Search connections..."/>
      </div>

      <div class="controls">
        <button class="btn ghost-toggle" (click)="gridView=false" [class.active]="!gridView" title="Table view">
          <!-- list icon -->
          <svg viewBox="0 0 24 24" class="icon"><rect x="4" y="5" width="16" height="3" rx="1.5"/><rect x="4" y="10.5" width="16" height="3" rx="1.5"/><rect x="4" y="16" width="10" height="3" rx="1.5"/></svg>
        </button>

        <button class="btn ghost-toggle" (click)="gridView=true" [class.active]="gridView" title="Card view">
          <!-- grid icon -->
          <svg viewBox="0 0 24 24" class="icon"><rect x="3.5" y="3.5" width="7" height="7" rx="1"/><rect x="13.5" y="3.5" width="7" height="7" rx="1"/><rect x="3.5" y="13.5" width="7" height="7" rx="1"/><rect x="13.5" y="13.5" width="7" height="7" rx="1"/></svg>
        </button>

        <button class="btn primary">
          <svg viewBox="0 0 24 24" class="icon plus"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          New Connection
        </button>
      </div>
    </div>
  </div>

  <div class="content glass">
    <!-- TABLE VIEW -->
    <div *ngIf="!gridView" class="table-wrap">
      <div class="table-header">
        <div class="th">Datasource</div>
        <div class="th">Server</div>
        <!-- <div class="th">Status</div> -->
        <div class="th">Created On</div>
        <div class="th">Last Modified</div>
        <div class="th actions-col">Actions</div>
      </div>

      <div class="table-body">
        <div *ngFor="let db of pagedItems()" class="table-row" (click)="viewConnection(db)">
          <div class="td datasource">
            <div class="avatar" [ngClass]="db.server_type.toLowerCase()">{{ db.display_name.charAt(0) }}</div>
            <div class="meta">
              <div class="name">{{ db.display_name }}</div>
              <div class="sub">{{ db.host || db.server_type }}</div>
            </div>
          </div>
          <div class="td server">{{ db.server_type }}</div>
          <!-- <div class="td status">
            <span class="status-pill" [attr.data-status]="db.status">{{ db.status }}</span>
          </div> -->
          <div class="td">{{ db.created_at }}</div>
          <div class="td">{{ db.updated_at }}</div>
          <div class="td actions-col">
            <button class="icon-btn" (click)="editConnection(db); $event.stopPropagation()" title="Edit">
              <svg viewBox="0 0 24 24" class="icon"><path d="M3 21l3-1 11-11 1-3-3 1L4 20z" fill="none" stroke="currentColor" stroke-width="1.4"/></svg>
            </button>
            <button class="icon-btn danger" (click)="deleteConnection(db); $event.stopPropagation()" title="Delete">
              <svg viewBox="0 0 24 24" class="icon"><path d="M3 6h18M8 6v12a2 2 0 002 2h4a2 2 0 002-2V6M10 6V4a2 2 0 012-2h0a2 2 0 012 2v2" fill="none" stroke="currentColor" stroke-width="1.4"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- CARD/GRID VIEW -->
    <div *ngIf="gridView" class="grid-wrap">
      <div class="grid" >
        <div *ngFor="let db of pagedItems()" class="card" (click)="viewConnection(db)">
          <div class="card-top">
            <div class="card-avatar" [ngClass]="db.server_type.toLowerCase()">{{ db.display_name.charAt(0) }}</div>
            <!-- <span class="status-pill" [attr.data-status]="db.status">{{ db.status }}</span> -->
          </div>
          <div class="card-body">
            <h3 class="card-title">{{ db.display_name }}</h3>
            <div class="card-sub">{{ db.host || db.server_type }}</div>

            <div class="card-meta">
              <div class="meta-row">
                <div class="meta-label">Created:</div>
                <div class="meta-value">{{ db.created_at }}</div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Modified:</div>
                <div class="meta-value">{{ db.updated_at }}</div>
              </div>
            </div>
          </div>

          <div class="card-actions">
            <button class="icon-btn" (click)="editConnection(db); $event.stopPropagation()" title="Edit">
              <svg viewBox="0 0 24 24" class="icon"><path d="M3 21l3-1 11-11 1-3-3 1L4 20z" fill="none" stroke="currentColor" stroke-width="1.4"/></svg>
            </button>
            <button class="icon-btn danger" (click)="deleteConnection(db); $event.stopPropagation()" title="Delete">
              <svg viewBox="0 0 24 24" class="icon"><path d="M3 6h18M8 6v12a2 2 0 002 2h4a2 2 0 002-2V6M10 6V4a2 2 0 012-2h0a2 2 0 012 2v2" fill="none" stroke="currentColor" stroke-width="1.4"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- pagination -->
    <div class="pager">
      <div class="pager-left">Showing {{ (connectionList.length ? connectionList.length : 0) }} connections</div>
      <div class="pager-right">
        <button class="page-btn" (click)="prevPage()">&lt;</button>

        <ng-container *ngFor="let n of [].constructor(totalPages); let i = index">
          <button class="page-pill" [class.active]="page === i+1" (click)="gotoPage(i+1)">{{ i+1 }}</button>
        </ng-container>

        <button class="page-btn" (click)="nextPage()">&gt;</button>

        <select class="page-size" [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()">
          <option value="8">8</option>
          <option value="12">12</option>
          <option value="20">20</option>
        </select>
      </div>
    </div>
  </div>
</div>
